name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  bindgen:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: Test
      run: cargo test  --manifest-path=bindgen/Cargo.toml --verbose
    - name: Tool
      run: cargo run --features=bin --manifest-path=bindgen/Cargo.toml --verbose CoreFoundation --sdk macosx

  sys-macos:
    strategy:
      matrix:
        feature: [
          AGL,
          AVFAudio,
          AVFoundation,
          AVKit,
          AVRouting,
          Accelerate,
          Accessibility,
          Accounts,
          AdServices,
          AdSupport,
          AddressBook,
          AppIntents,
          AppKit,
          AppTrackingTransparency,
          AppleScriptKit,
          AppleScriptObjC,
          ApplicationServices,
          AudioToolbox,
          AudioUnit,
          AudioVideoBridging,
          AuthenticationServices,
          AutomaticAssessmentConfiguration,
          Automator,
          BackgroundAssets,
          BackgroundTasks,
          BusinessChat,
          CFNetwork,
          CalendarStore,
          CallKit,
          Carbon,
          ClassKit,
          CloudKit,
          Cocoa,
          Collaboration,
          ColorSync,
          Contacts,
          ContactsUI,
          CoreAudio,
          CoreAudioKit,
          CoreBluetooth,
          CoreData,
          CoreFoundation,
          CoreGraphics,
          CoreHaptics,
          CoreImage,
          CoreLocation,
          CoreMIDI,
          CoreML,
          CoreMedia,
          CoreMediaIO,
          CoreMotion,
          CoreServices,
          CoreSpotlight,
          CoreTelephony,
          CoreText,
          CoreTransferable,
          CoreVideo,
          CoreWLAN,
          CryptoTokenKit,
          DVDPlayback,
          DataDetection,
          DeviceCheck,
          DirectoryService,
          DiscRecording,
          DiscRecordingUI,
          DiskArbitration,
          EventKit,
          ExceptionHandling,
          ExecutionPolicy,
          ExposureNotification,
          ExtensionFoundation,
          ExtensionKit,
          ExternalAccessory,
          FileProvider,
          FileProviderUI,
          FinderSync,
          ForceFeedback,
          Foundation,
          GLKit,
          GLUT,
          GSS,
          GameController,
          GameKit,
          GameplayKit,
          HealthKit,
          Hypervisor,
          ICADevices,
          IMServicePlugIn,
          IOBluetooth,
          IOBluetoothUI,
          IOKit,
          IOSurface,
          IOUSBHost,
          IdentityLookup,
          ImageCaptureCore,
          ImageIO,
          InputMethodKit,
          InstallerPlugins,
          InstantMessage,
          Intents,
          IntentsUI,
          JavaNativeFoundation,
          JavaRuntimeSupport,
          JavaScriptCore,
          Kerberos,
          KernelManagement,
          LDAP,
          LatentSemanticMapping,
          LinkPresentation,
          LocalAuthentication,
          LocalAuthenticationEmbeddedUI,
          MLCompute,
          MailKit,
          MapKit,
          Matter,
          MediaAccessibility,
          MediaLibrary,
          MediaPlayer,
          MediaToolbox,
          Metal,
          MetalFX,
          MetalKit,
          # MetalPerformanceShaders,  -- exceed max arg
          # MetalPerformanceShadersGraph,  -- exceed max arg
          MetricKit,
          ModelIO,
          MultipeerConnectivity,
          NaturalLanguage,
          NearbyInteraction,
          NetFS,
          Network,
          NetworkExtension,
          NotificationCenter,
          OSAKit,
          OSLog,
          OpenAL,
          OpenCL,
          OpenDirectory,
          OpenGL,
          PCSC,
          PDFKit,
          PHASE,
          ParavirtualizedGraphics,
          PassKit,
          PencilKit,
          Photos,
          PhotosUI,
          PreferencePanes,
          PushKit,
          Quartz,
          QuartzCore,
          QuickLook,
          QuickLookThumbnailing,
          QuickLookUI,
          ReplayKit,
          SafariServices,
          SafetyKit,
          SceneKit,
          # ScreenCaptureKit,  -- failing on CI env
          ScreenSaver,
          ScreenTime,
          ScriptingBridge,
          Security,
          SecurityFoundation,
          SecurityInterface,
          SensorKit,
          ServiceManagement,
          SharedWithYou,
          SharedWithYouCore,
          ShazamKit,
          Social,
          SoundAnalysis,
          Speech,
          SpriteKit,
          StoreKit,
          SwiftUI,
          SyncServices,
          SystemConfiguration,
          SystemExtensions,
          TWAIN,
          Tcl,
          ThreadNetwork,
          UniformTypeIdentifiers,
          UserNotifications,
          UserNotificationsUI,
          VideoDecodeAcceleration,
          VideoSubscriberAccount,
          VideoToolbox,
          Virtualization,
          Vision,
          VisionKit,
          # WebKit,  -- exceed max arg
          WidgetKit,
          iTunesLibrary,
          vmnet
        ]
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: Build
      run: cargo build  --manifest-path=sys/Cargo.toml --verbose --features ${{ matrix.feature }}
  sys-ios:
    strategy:
      matrix:
        feature: [
          ARKit,
          AVFAudio,
          AVFoundation,
          AVKit,
          AVRouting,
          Accelerate,
          Accessibility,
          Accounts,
          ActivityKit,
          AdServices,
          AdSupport,
          AddressBook,
          # AddressBookUI,
          AppClip,
          AppIntents,
          AppTrackingTransparency,
          AssetsLibrary,
          AudioToolbox,
          AudioUnit,
          AuthenticationServices,
          AutomaticAssessmentConfiguration,
          BackgroundAssets,
          BackgroundTasks,
          BusinessChat,
          CFNetwork,
          CallKit,
          CarPlay,
          ClassKit,
          ClockKit,
          CloudKit,
          ColorSync,
          Contacts,
          ContactsUI,
          CoreAudio,
          CoreAudioKit,
          CoreBluetooth,
          CoreData,
          CoreFoundation,
          CoreGraphics,
          CoreHaptics,
          CoreImage,
          CoreLocation,
          CoreLocationUI,
          CoreMIDI,
          CoreML,
          CoreMedia,
          CoreMotion,
          CoreNFC,
          CoreServices,
          CoreSpotlight,
          CoreTelephony,
          CoreText,
          CoreTransferable,
          CoreVideo,
          CryptoTokenKit,
          DataDetection,
          DeviceCheck,
          DeviceDiscoveryExtension,
          EventKit,
          EventKitUI,
          ExposureNotification,
          ExtensionFoundation,
          ExtensionKit,
          ExternalAccessory,
          FileProvider,
          FileProviderUI,
          Foundation,
          GLKit,
          GSS,
          GameController,
          GameKit,
          GameplayKit,
          HealthKit,
          HealthKitUI,
          HomeKit,
          IOKit,
          IOSurface,
          IdentityLookup,
          IdentityLookupUI,
          ImageCaptureCore,
          ImageIO,
          Intents,
          IntentsUI,
          JavaScriptCore,
          LinkPresentation,
          LocalAuthentication,
          LocalAuthenticationEmbeddedUI,
          MLCompute,
          MapKit,
          Matter,
          MatterSupport,
          MediaAccessibility,
          MediaPlayer,
          MediaSetup,
          MediaToolbox,
          MessageUI,
          Messages,
          Metal,
          MetalFX,
          MetalKit,
          # MetalPerformanceShaders,
          # MetalPerformanceShadersGraph,
          MetricKit,
          MobileCoreServices,
          ModelIO,
          MultipeerConnectivity,
          NaturalLanguage,
          NearbyInteraction,
          Network,
          NetworkExtension,
          NewsstandKit,
          NotificationCenter,
          OSLog,
          OpenAL,
          OpenGLES,
          PDFKit,
          PHASE,
          PassKit,
          PencilKit,
          Photos,
          PhotosUI,
          ProximityReader,
          PushKit,
          PushToTalk,
          QuartzCore,
          QuickLook,
          QuickLookThumbnailing,
          ReplayKit,
          RoomPlan,
          SafariServices,
          SafetyKit,
          SceneKit,
          ScreenTime,
          Security,
          SensorKit,
          SharedWithYou,
          SharedWithYouCore,
          ShazamKit,
          Social,
          SoundAnalysis,
          Speech,
          SpriteKit,
          StoreKit,
          SwiftUI,
          SystemConfiguration,
          ThreadNetwork,
          Twitter,
          UIKit,
          UniformTypeIdentifiers,
          UserNotifications,
          UserNotificationsUI,
          VideoSubscriberAccount,
          VideoToolbox,
          Vision,
          VisionKit,
          WatchConnectivity,
          # WebKit,  -- exceed max arg
          WidgetKit,
          iAd
        ]
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: prepare iOS build
      uses: dtolnay/rust-toolchain@stable
      with:
        target: aarch64-apple-ios
    - name: Build
      run: cargo build --target=aarch64-apple-ios --manifest-path=sys/Cargo.toml --verbose --features ${{ matrix.feature }}
